<?php
session_start();
if (!isset($_SESSION['admin'])) {
    header("Location: app.php?url=admin");
    exit;
}
?>
<!DOCTYPE html>
<html lang="en" class="h-100">
<head>
    <title>Admin Panel</title>
    <?php include 'meta.html'; ?>
    <style>
        input, textarea { display: block; width: 100%; margin-bottom: 10px; }
        body{
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
    </style>
</head>
<body class="h-100 pt-sm-3 pb-sm-3">
        <div class="container h-100 bg-light p-3 overflow-auto fs-4">
            <div class="container p-3 bg-light fs-5">
                <h2>Create New Exam</h2>
                <select id="title" class="form-control mb-2" name="subjects">
                    <!-- Primary School Subjects -->
                    <option value="English Language">English Language</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="Basic Science and Technology">Basic Science and Technology</option>
                    <option value="Social Studies">Social Studies</option>
                    <option value="Civic Education">Civic Education</option>
                    <option value="Cultural and Creative Arts">Cultural and Creative Arts</option>
                    <option value="Agricultural Science">Agricultural Science</option>
                    <option value="Religious Studies (CRS/IRS)">Religious Studies (CRS/IRS)</option>
                    <option value="Physical and Health Education">Physical and Health Education</option>
                    <option value="Computer Studies/ICT">Computer Studies/ICT</option>
                    <option value="Arabic Language">Arabic Language</option>
                    <option value="French Language">French Language</option>
                    <option value="Home Economics">Home Economics</option>
                    <option value="Igbo Language">Nigerian Languages (Igbo)</option>
                    <option value="Yoruba Language">Nigerian Languages (Yoruba)</option>
                    <option value="Hausa Language">Nigerian Languages (Hausa)</option>
                  
                    <!-- Junior Secondary School Subjects -->
                    <option value="Basic Science">Basic Science</option>
                    <option value="Basic Technology">Basic Technology</option>
                    <option value="Business Studies">Business Studies</option>
                    <option value="Home Economics (JSS)">Home Economics (JSS)</option>
                    <option value="Christian Religious Studies">Christian Religious Studies</option>
                    <option value="Islamic Religious Studies">Islamic Religious Studies</option>
                  
                    <!-- Senior Secondary School Subjects -->
                    <option value="Biology">Biology</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Physics">Physics</option>
                    <option value="Further Mathematics">Further Mathematics</option>
                    <option value="Economics">Economics</option>
                    <option value="Geography">Geography</option>
                    <option value="Government">Government</option>
                    <option value="Literature in English">Literature in English</option>
                    <option value="Commerce">Commerce</option>
                    <option value="Financial Accounting">Financial Accounting</option>
                    <option value="Technical Drawing">Technical Drawing</option>
                    <option value="Agricultural Science (SSS)">Agricultural Science (SSS)</option>
                    <option value="Data Processing">Data Processing</option>
                    <option value="Civic Education (SSS)">Civic Education (SSS)</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Food and Nutrition">Food and Nutrition</option>
                    <option value="Visual Arts">Visual Arts</option>
                    <option value="Music">Music</option>
                    <option value="History">History</option>
                    <option value="French (SSS)">French (SSS)</option>
                    <option value="Arabic (SSS)">Arabic (SSS)</option>
                    <option value="Tourism">Tourism</option>
                    <option value="Christian Religious Knowledge">Christian Religious Knowledge</option>
                    <option value="Islamic Religious Knowledge">Islamic Religious Knowledge</option>
                  </select>                  
                <select name="" id="class" class="form-control mb-2">
                    <!-- Nursery / Kindergarten -->
                    <option value="Nursery 1">Nursery 1</option>
                    <option value="Nursery 2">Nursery 2</option>
                    <option value="Kindergarten">Kindergarten</option>

                    <!-- Primary School -->
                    <option value="Primary 1">Primary 1</option>
                    <option value="Primary 2">Primary 2</option>
                    <option value="Primary 3">Primary 3</option>
                    <option value="Primary 4">Primary 4</option>
                    <option value="Primary 5">Primary 5</option>
                    <option value="Primary 6">Primary 6</option>

                    <!-- Junior Secondary School -->
                    <option value="JSS 1">JSS 1</option>
                    <option value="JSS 2">JSS 2</option>
                    <option value="JSS 3">JSS 3</option>

                    <!-- Senior Secondary School -->
                    <option value="SSS 1">SSS 1</option>
                    <option value="SSS 2">SSS 2</option>
                    <option value="SSS 3">SSS 3</option>
                </select>
                <input id="duration" class="form-control mb-3" placeholder="Duration (in minutes)">
            
                <h4>Add Question</h4>
                <input id="qText" class="form-control mb-2" placeholder="Enter question text">
            
                <div class="row">
                    <div class="col-6">
                        <input class="form-control mb-2" id="optA" placeholder="Option A">
                    </div>
                    <div class="col-6">
                        <input class="form-control mb-2" id="optB" placeholder="Option B">
                    </div>
                    <div class="col-6">
                        <input class="form-control mb-2" id="optC" placeholder="Option C">
                    </div>
                    <div class="col-6">
                        <input class="form-control mb-2" id="optD" placeholder="Option D">
                    </div>
                </div>
            
                <div class="mb-3">
                    <label>Select Correct Option(s):</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkA"> <label class="form-check-label" for="chkA">A</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkB"> <label class="form-check-label" for="chkB">B</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkC"> <label class="form-check-label" for="chkC">C</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkD"> <label class="form-check-label" for="chkD">D</label>
                    </div>
                </div>
            
                <!-- <button class="btn btn-secondary mb-3" onclick="addQuestion()">+ Add Question</button> -->
                <button id="addUpdateBtn" class="btn btn-secondary mb-3" onclick="addOrUpdateQuestion()">Add Question</button>

                <h4>Questions Added</h4>
                <div id="questionsList" class="mb-3"></div>
            
                <button class="btn btn-primary" onclick="createExam()">Save Exam</button>
            </div>
        </div>

<script>
let questions = [];
let editIndex = -1;

function addQuestion() {
    const qText = document.getElementById('qText').value.trim();
    const options = {
        a: document.getElementById('optA').value.trim(),
        b: document.getElementById('optB').value.trim(),
        c: document.getElementById('optC').value.trim(),
        d: document.getElementById('optD').value.trim()
    };
    const correct = document.getElementById('correct').value;

    if (!qText || !options.a || !options.b || !options.c || !options.d || !correct) {
        Swal.fire('Incomplete', 'Fill all fields and select correct answer.', 'warning');
        return;
    }

    questions.push({ question: qText, options, correct });
    updateQuestionsList();
    clearQuestionForm();
}

// function updateQuestionsList() {
//     const container = document.getElementById('questionsList');
//     container.innerHTML = '';

//     questions.forEach((q, index) => {
//         const html = `
//             <div class="border rounded p-2 mb-3 position-relative">
//                 <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" onclick="removeQuestion(${index})">Remove</button>
//                 <strong>Q${index + 1} (${q.type === 'multiple' ? 'Multiple Choice' : 'Single Choice'}):</strong> ${q.question}
//                 <ul>
//                     ${Object.entries(q.options).map(([key, val]) => `
//                         <li>${key.toUpperCase()}. ${val} ${q.correct.includes(key) ? '(Correct)' : ''}</li>
//                     `).join('')}
//                 </ul>
//             </div>`;
//         container.innerHTML += html;
//     });
// }

function updateQuestionsList() {
    const container = document.getElementById('questionsList');
    container.innerHTML = '';

    questions.forEach((q, index) => {
        const html = `
            <div class="border rounded p-2 mb-3 position-relative">
                <div class="position-absolute top-0 end-0 m-2 d-flex gap-1">
                    <button class="btn btn-sm btn-warning" onclick="editQuestion(${index})">✏ Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="removeQuestion(${index})">🗑 Remove</button>
                </div>
                <strong>Q${index + 1} (${q.type === 'multiple' ? 'Multiple Choice' : 'Single Choice'}):</strong> ${q.question}
                <ul>
                    ${Object.entries(q.options).map(([key, val]) => `
                        <li>${key.toUpperCase()}. ${val} ${q.correct.includes(key) ? '(Correct)' : ''}</li>
                    `).join('')}
                </ul>
            </div>`;
        container.innerHTML += html;
    });

    // Reset add/update button state
    document.getElementById('addUpdateBtn').textContent = 'Add Question';
    editIndex = -1;
}




function removeQuestion(index) {
    Swal.fire({
        title: 'Are you sure?',
        text: "Do you want to remove this question?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, remove it!',
    }).then((result) => {
        if (result.isConfirmed) {
            questions.splice(index, 1);
            updateQuestionsList();
        }
    });
}

function addOrUpdateQuestion() {
    const qText = document.getElementById('qText').value.trim();
    const options = {
        a: document.getElementById('optA').value.trim(),
        b: document.getElementById('optB').value.trim(),
        c: document.getElementById('optC').value.trim(),
        d: document.getElementById('optD').value.trim()
    };
    const correct = [];
    if (document.getElementById('chkA').checked) correct.push('a');
    if (document.getElementById('chkB').checked) correct.push('b');
    if (document.getElementById('chkC').checked) correct.push('c');
    if (document.getElementById('chkD').checked) correct.push('d');

    if (!qText || !options.a || !options.b || !options.c || !options.d || correct.length === 0) {
        Swal.fire('Incomplete', 'Fill all options and select at least one correct answer.', 'warning');
        return;
    }

    const type = correct.length > 1 ? 'multiple' : 'single';
    const newQ = { question: qText, options, correct, type };

    if (editIndex >= 0) {
        // Update mode
        questions[editIndex] = newQ;
        Swal.fire('Updated', 'Question updated.', 'success');
    } else {
        // Add mode
        questions.push(newQ);
        Swal.fire('Added', 'Question added.', 'success');
    }

    updateQuestionsList();
    clearQuestionForm();
}



function editQuestion(index) {
    const q = questions[index];
    document.getElementById('qText').value = q.question;
    document.getElementById('optA').value = q.options.a;
    document.getElementById('optB').value = q.options.b;
    document.getElementById('optC').value = q.options.c;
    document.getElementById('optD').value = q.options.d;

    document.getElementById('chkA').checked = q.correct.includes('a');
    document.getElementById('chkB').checked = q.correct.includes('b');
    document.getElementById('chkC').checked = q.correct.includes('c');
    document.getElementById('chkD').checked = q.correct.includes('d');

    editIndex = index;
    document.getElementById('addUpdateBtn').textContent = 'Update Question';
}



function clearQuestionForm() {
    document.getElementById('qText').value = '';
    document.getElementById('optA').value = '';
    document.getElementById('optB').value = '';
    document.getElementById('optC').value = '';
    document.getElementById('optD').value = '';
    document.getElementById('chkA').checked = false;
    document.getElementById('chkB').checked = false;
    document.getElementById('chkC').checked = false;
    document.getElementById('chkD').checked = false;
}

function createExam() {
    const data = {
        title: document.getElementById('title').value.trim(),
        class: document.getElementById('class').value.trim(),
        duration: document.getElementById('duration').value.trim(),
        questions
    };

    if (!data.title || !data.class || !data.duration || questions.length === 0) {
        Swal.fire('Incomplete', 'Fill exam details and add at least one question.', 'warning');
        return;
    }

    fetch('app.php?url=create-exam', {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => {
        Swal.fire(res.status ? 'Success' : 'Error', res.message, res.status ? 'success' : 'error');
    })
    .catch(err => {
        console.error(err);
        Swal.fire('Error', 'Something went wrong.', 'error');
    });
}
</script>

</body>
</html>
